<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Codeforces 并发爬虫控制台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        #table-wrapper {
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 1rem;
            background: #f9f9f9;
        }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <div class="row">
            <!-- 左侧参数设置 -->
            <div class="col-md-4">
                <h4>Codeforces爬虫参数设置</h4>
                <form id="scraper-form">
                    <div class="form-group">
                        <label>起始页:</label>
                        <input type="number" name="from_page" class="form-control" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>结束页:</label>
                        <input type="number" name="to_page" class="form-control" value="10" min="1">
                    </div>
                    <div class="form-group">
                        <label>线程数:</label>
                        <input type="number" name="threads" class="form-control" value="5" min="1" max="20">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">开始爬取</button>
                </form>

                <div id="output" class="alert alert-info mt-3" style="display:none;"></div>
            </div>

            <!-- 右侧结果展示 -->
            <div class="col-md-8">
                <h4>爬取结果</h4>
                <div id="table-wrapper"></div>
            </div>
        </div>
    </div>

    <script>
        let pollingTimer = null;
        let currentTaskId = null;

        document.getElementById("scraper-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const output = document.getElementById("output");
            const tableWrapper = document.getElementById("table-wrapper");

            output.style.display = "block";
            output.className = "alert alert-info";
            output.innerText = "⏳ 已提交任务，后台正在执行...";
            tableWrapper.innerHTML = "";

            fetch("/start", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                currentTaskId = data.task_id;

                pollingTimer = setInterval(() => {
                    fetch("/task_status?task_id=" + currentTaskId)
                        .then(res => res.json())
                        .then(status => {
                            if (status.status === "done") {
                                clearInterval(pollingTimer);
                                output.className = "alert alert-success";
                                output.innerText = `✅ 任务完成，正在加载...`;

                                fetch(`/read_csv?filename=${encodeURIComponent(status.filename)}`)
                                    .then(res => res.json())
                                    .then(rows => renderTable(rows));
                            } else if (status.status === "error") {
                                clearInterval(pollingTimer);
                                output.className = "alert alert-danger";
                                output.innerText = "❌ 任务失败：" + status.error;
                            } else {
                                output.innerText = `⏳ ${status.status} | 已完成 ${status.progress.done} / ${status.progress.total} 页`;
                            }
                        });
                }, 3000);
            });
        });

        function renderTable(rows) {
            const tableWrapper = document.getElementById("table-wrapper");
            const table = document.createElement("table");
            table.className = "table table-bordered table-sm";

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            Object.keys(rows[0]).forEach(key => {
                const th = document.createElement("th");
                th.innerText = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            rows.forEach(row => {
                const tr = document.createElement("tr");
                Object.values(row).forEach(val => {
                    const td = document.createElement("td");
                    td.innerText = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            tableWrapper.innerHTML = "";
            tableWrapper.appendChild(table);
        }
    </script>
</body>
</html>

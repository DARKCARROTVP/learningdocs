<!DOCTYPE html>

<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Codeforces 并发爬虫系统</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script>
function benchmarkThreads() {
  const start = parseInt(document.getElementById('start').value);
  const end = parseInt(document.getElementById('end').value);
  const maxThreads = parseInt(prompt("请输入最大线程数", "10"));
  if (!maxThreads || maxThreads < 1 || isNaN(start) || isNaN(end) || end < start) {
    return alert("请输入有效参数！");
  }

  const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
  progressModal.show();
  updateProgress(0, maxThreads);

  fetch(`/benchmark_threads?start=${start}&end=${end}&max_threads=${maxThreads}`)
    .then(res => res.json())
    .then(() => console.log("Benchmark started"));

  const interval = setInterval(() => {
    fetch("/benchmark_progress")
      .then(res => res.json())
      .then(stat => {
        updateProgress(stat.current, stat.total);
        if (stat.done) {
          clearInterval(interval);
          fetch("/benchmark_result")
            .then(res => res.json())
            .then(results => {
              const labels = results.map(r => `T${r.threads}`);
              const data = results.map(r => r.duration);
              renderChart(labels, data, `线程数 vs 总耗时（page${start}-${end}）`, null, null, "line");
              const imgContainer = document.createElement("div");
              imgContainer.className = "mt-3";
              imgContainer.innerHTML = `<img src="/data/benchmark_threads.png" class="img-fluid border rounded">`;
              document.getElementById("result-table").innerHTML = '';
              document.getElementById("result-table").appendChild(imgContainer);
            });
        }
      });
  }, 1000);
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
<h2 class="mb-4">Codeforces 并发爬虫系统</h2>
<div class="row">
<div class="col-md-6">
<form class="row g-3" id="task-form">
<div class="col-4">
<label class="form-label" for="start">起始页</label>
<input class="form-control" id="start" name="start" type="number" value="1"/>
</div>
<div class="col-4">
<label class="form-label" for="end">结束页（&lt;852）</label>
<input class="form-control" id="end" name="end" type="number" value="1"/>
</div>
<div class="col-4">
<label class="form-label" for="threads">线程数</label>
<input class="form-control" id="threads" name="threads" type="number" value="1"/>
</div>
<div class="col-12">
<button class="btn btn-primary mt-2" type="submit">开始爬取</button>

</div>
</form>
<div class="mt-4">
<h5>即将爬取的 Codeforces URL 列表</h5>
<div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
<table class="table table-sm table-bordered" id="url-table">
<colgroup>
<col style="width: 50px;"/>
<col style="width: 70%;"/>
<col style="width: 80px;"/>
</colgroup>
<thead><tr><th>ID</th><th>URL</th><th>数据量（条）</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
<div class="col-md-6">
<h5 class="mt-4">爬取结果</h5>
<div class="border rounded p-2" id="result-table" style="max-height: 200px; overflow-y: scroll;">
<p class="text-muted">等待任务完成后展示数据…</p>
</div>
<h5 class="mt-4">线程可视化</h5>
<div class="mt-3 d-flex gap-2 flex-wrap">
<button class="btn btn-secondary" onclick="showRawData()">展示爬取数据</button>
<button class="btn btn-success" onclick="showThreadInfo()">线程信息</button>
<button class="btn btn-success" onclick="showTimingChart()">各线程运行时间趋势可视化</button>
<button class="btn btn-success" onclick="showStartEndChart()">线程开始与结束时间</button>
<button class="btn btn-warning" onclick="benchmarkThreads()">探索最佳线程数</button>
</div>
<canvas class="mt-3" height="320" id="chart-canvas"></canvas>
</div>
</div>
<div aria-hidden="true" aria-labelledby="progressModalLabel" class="modal fade" id="progressModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="progressModalLabel">任务进度</h5>
<button aria-label="关闭" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="progress" style="height: 25px;">
<div class="progress-bar bg-success" id="progress-bar" role="progressbar" style="width: 0%;">0%</div>
</div>
<p class="mt-2 mb-0 text-center" id="progress-text">当前进度：0 / 0</p>
</div>
</div>
</div>
</div>
<script>
let latestFile = null;
let latestTiming = null;
let chartRef = null;
let dataRendered = false;
let progressInterval = null;
let currentTaskId = null;

function renderURLTable(start, end) {
  const tbody = document.querySelector('#url-table tbody');
  tbody.innerHTML = '';
  for (let i = start; i <= end; i++) {
    const url = `https://codeforces.com/ratings/page/${i}`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i}</td><td>${url}</td><td>200</td>`;
    tbody.appendChild(tr);
  }
}

function resetUI() {
  dataRendered = false;
  latestFile = null;
  latestTiming = null;
  currentTaskId = Math.random().toString(36).substring(2);
  if (chartRef) {
    chartRef.destroy();
    chartRef = null;
  }
  document.getElementById('progress-bar').style.width = '0%';
  document.getElementById('progress-bar').textContent = '0%';
  document.getElementById('progress-text').textContent = '当前进度：0 / 0';
  document.getElementById('result-table').innerHTML = "<p class='text-muted'>等待任务完成后展示数据…</p>";
}

document.getElementById('task-form').addEventListener('submit', function(event) {
  event.preventDefault();
  const start = parseInt(document.getElementById('start').value);
  const end = parseInt(document.getElementById('end').value);
  renderURLTable(start, end);
  resetUI();
  const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
  progressModal.show();
  if (progressInterval) clearInterval(progressInterval);
  const formData = new FormData(this);
  progressInterval = setInterval(() => checkProgress(currentTaskId), 2000);
  currentTaskId = Math.random().toString(36).substring(2);
  fetch('/start', {
    method: 'POST',
    body: formData
  }).then(res => res.json()).then(data => {
    if (data.filename) latestFile = data.filename;
    alert(data.message);
  });
});

function checkProgress(taskId) {
  fetch('/progress')
    .then(res => res.json())
    .then(data => {
      if (taskId !== currentTaskId) return;
      const { current, total, filename } = data;
      const percent = total === 0 ? 0 : Math.round((current / total) * 100);
      document.getElementById('progress-bar').style.width = percent + '%';
      document.getElementById('progress-bar').textContent = percent + '%';
      document.getElementById('progress-text').textContent = `当前进度：${current} / ${total}`;
      if (current === total && total > 0 && filename && !dataRendered) {
        latestFile = filename;
        dataRendered = true;
        fetchAndRenderCSV(filename);
        fetch(`/timing/${filename}`)
          .then(res => res.json())
          .then(json => {
            if (taskId !== currentTaskId) return;
            latestTiming = json;
            showTimingChart();
          });
        clearInterval(progressInterval);
      }
    });
}

function fetchAndRenderCSV(filename) {
  fetch(`/data/${filename}`)
    .then(res => res.text())
    .then(csv => {
      const rows = csv.trim().split("\n").map(row => row.split(","));
      let html = "<table class='table table-sm table-bordered'><thead><tr>";
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(col => html += `<td>${col}</td>`);
        html += "</tr>";
      }
      html += "</tbody></table>";
      document.getElementById("result-table").innerHTML = html;
    });
}

function updateProgress(current, total) {
  const percent = Math.floor((current / total) * 100);
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("progress-text");

  if (bar) {
    bar.style.width = percent + "%";
    bar.innerText = percent + "%";
  }

  if (text) {
    text.innerText = `当前进度：${current} / ${total}`;
  }
}

function benchmarkThreads() {
  const start = parseInt(document.getElementById('start').value);
  const end = parseInt(document.getElementById('end').value);
  const maxThreads = parseInt(prompt("请输入最大线程数", "10"));

  if (!maxThreads || maxThreads < 1 || isNaN(start) || isNaN(end) || end < start) {
    return alert("请输入有效参数！");
  }

  // 重置进度条
  updateProgress(0, maxThreads);

  // 启动 benchmark 任务
  fetch(`/benchmark_threads?start=${start}&end=${end}&max_threads=${maxThreads}`)
    .then(res => res.json())
    .then(result => {
      console.log("Benchmark started:", result.message);
    });

  // 启动轮询进度
  const interval = setInterval(() => {
    fetch("/benchmark_progress")
      .then(res => res.json())
      .then(stat => {
        updateProgress(stat.current, stat.total);
        if (stat.done) {
          clearInterval(interval);
          fetch("/benchmark_result")
            .then(res => res.json())
            .then(results => {
              const labels = results.map(r => `T${r.threads}`);
              const data = results.map(r => r.duration);
              renderChart(labels, data, `线程数 vs 总耗时（page${start}-${end}）`, null, null, 'line');

              // 显示保存的图像
              const imgContainer = document.createElement("div");
              imgContainer.className = "mt-3";
              imgContainer.innerHTML = `<img src="/data/benchmark_threads.png" class="img-fluid border rounded">`;
              document.getElementById("result-table").innerHTML = '';
              document.getElementById("result-table").appendChild(imgContainer);
            });
        }
      });
  }, 1000);
}


function showRawData() {
  if (!latestFile) return;
  fetchAndRenderCSV(latestFile);
}

  function showThreadInfo() {
    if (!latestTiming) return;
  
    const grouped = {};
  
    latestTiming.pages.forEach(p => {
      const tid = p.thread_id ?? '未知';
      if (!grouped[tid]) grouped[tid] = [];
      grouped[tid].push(p);
    });
  
    const rows = Object.entries(grouped).map(([tid, items]) => {
      const start = Math.min(...items.map(p => p.start));
      const end = Math.max(...items.map(p => p.end));
      const duration = (end - start).toFixed(2);
      const count = items.length;
      const size = count.toFixed(2)*200;

      return `<tr>
        <td>T${tid}</td>
        <td>${formatAbsTime(start)}</td>
        <td>${formatAbsTime(end)}</td>
        <td>${duration}</td>
        <td>${count}</td>
        <td>${size}</td>
      </tr>`;
    }).join('');
  
    document.getElementById("result-table").innerHTML = `
      <table class="table table-bordered text-center align-middle" style="font-size: 15px;">
        <thead>
          <tr>
            <th style="background-color:#b3e0ff;">线程号</th>
            <th style="background-color:#d0f0c0;">开始时间</th>
            <th style="background-color:#fef3c0;">结束时间</th>
            <th style="background-color:#fddde6;">耗时</th>
            <th style="background-color:#ffd8b1;">URL数量</th>
            <th style="background-color:#eee;">任务量（条）</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }
  
  function formatAbsTime(t) {
    const d = new Date(t * 1000); // 秒 → 毫秒
    const pad = (n) => String(n).padStart(2, '0');
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}.${String(d.getMilliseconds()).padStart(3, '0')}`;
  }
   

function showTimingChart() {
  if (!latestTiming) return;
  const labels = latestTiming.pages.map(p => `第${p.page}页`);
  const data = latestTiming.pages.map(p => p.duration);
  renderChart(labels, data, '每页爬取耗时（秒）');
}

function showStartEndChart() {
  if (!latestTiming) return;

  const baseTime = latestTiming.task_start;
  const pages = latestTiming.pages;

  const threads = {};
  for (const p of pages) {
    const tid = p.thread_id ?? '未知';
    if (!threads[tid]) threads[tid] = [];
    threads[tid].push(p);
  }

  const threadIds = Object.keys(threads);
  const labels = threadIds.map(tid => `线程 ${tid}`);
  const data = [];

  threadIds.forEach((tid) => {
    threads[tid].forEach(task => {
      const start = +(task.start - baseTime).toFixed(2);
      const end = +(task.end - baseTime).toFixed(2);
      data.push({
        xMin: start,
        xMax: end,
        y: `线程 ${tid}`,
        page: task.page
      });
    });
  });

  if (chartRef) chartRef.destroy();

  chartRef = new Chart(document.getElementById('chart-canvas'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: '页面任务',
        data: data,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        barPercentage: 1.0,
        categoryPercentage: 1.0,
        borderRadius: 3
      }]
    },
    options: {
      indexAxis: 'y',
      parsing: {
        xAxisKey: 'xMax',
        xMinKey: 'xMin'
      },
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: '线程任务时间轴'
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const dur = (ctx.raw.xMax - ctx.raw.xMin).toFixed(2);
              return `第 ${ctx.raw.page} 页：开始于 ${ctx.raw.xMin}s，耗时 ${dur}s`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'linear',
          title: { display: true, text: '时间（秒）' }
        },
        y: {
          title: { display: true, text: '线程 ID' }
        }
      }
    }
  });
}

  function showTimingChart() {
    if (!latestTiming) return;
    const labels = latestTiming.pages.map(p => `第${p.page}页`);
    const data = latestTiming.pages.map(p => p.duration);
    renderChart(labels, data, '每页爬取耗时（秒）', null, null, 'line');
  }

  function renderChart(labels, data1, label1, data2 = null, label2 = null, chartType = 'bar') {
    if (chartRef) chartRef.destroy();
    const datasets = [{
      label: label1,
      data: data1,
      backgroundColor: chartType === 'bar' ? 'rgba(75, 192, 192, 0.6)' : undefined,
      borderColor: 'rgba(75, 192, 192, 1)',
      tension: 0.3,
      fill: false,
      pointRadius: chartType === 'line' ? 4 : 0
    }];
    if (data2 && label2) {
      datasets.push({
        label: label2,
        data: data2,
        backgroundColor: chartType === 'bar' ? 'rgba(255, 99, 132, 0.6)' : undefined,
        borderColor: 'rgba(255, 99, 132, 1)',
        tension: 0.3,
        fill: false,
        pointRadius: chartType === 'line' ? 4 : 0
      });
    }
    chartRef = new Chart(document.getElementById('chart-canvas'), {
      type: chartType,
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: label1 }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: label1.includes('线程') ? '线程编号' : '耗时（秒）' }
          },
          x: {
            title: { display: true, text: '页码' }
          }
        }
      }
    });
  }
</script>

</body>
</html>
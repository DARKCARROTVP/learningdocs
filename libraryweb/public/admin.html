<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å‘˜å›¾ä¹¦ç®¡ç†</title>
  <script src="auth-guard.js"></script>
  <style>
    body {
      font-family: "Arial", sans-serif;
      margin: 40px auto;
      max-width: 1000px;
      background-color: #f9f9f9;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    #navbar {
      text-align: center;
      margin-bottom: 30px;
    }
    #navbar button {
      margin: 0 5px;
      padding: 8px 14px;
      font-weight: bold;
    }
    input {
      padding: 6px;
      margin: 5px;
      width: 250px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    button.action-btn {
      padding: 5px 10px;
    }
    #uploadForm {
      display: none;
      text-align: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div id="navbar">
  <button onclick="location.href='index.html'">ğŸ  é¦–é¡µ</button>
  <button onclick="location.href='mybooks.html'" id="mybooksBtn" style="display:none">ğŸ“– æˆ‘çš„å€Ÿä¹¦</button>
  <button onclick="location.href='admin.html'" id="adminBtn" style="display:none">ğŸ›  ç®¡ç†å›¾ä¹¦</button>
  <div style="text-align: center; margin-bottom: 10px;">
    <button onclick="exportCSV()">ğŸ“¥ å¯¼å‡ºå€Ÿé˜…æ•°æ® CSV</button>
  </div>  
  <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
</div>

<script>
  const isAdmin = localStorage.getItem("admin") === "true";
  const student_id = localStorage.getItem("student_id");

  if (student_id) document.getElementById("mybooksBtn").style.display = "inline";
  if (isAdmin) document.getElementById("adminBtn").style.display = "inline";

  function logout() {
    localStorage.clear();
    alert("å·²é€€å‡ºç™»å½•");
    location.href = "login.html";
  }
  function exportCSV() {
    window.open('/api/export');
  }  
</script>

<h2>ğŸ“š å›¾ä¹¦ç®¡ç†</h2>

<!-- æ§åˆ¶åŒºï¼šæ–°å¢æŒ‰é’® + æœç´¢æ  -->
<div style="text-align: center;">
  <button onclick="toggleForm()">â• æ–°å¢å›¾ä¹¦</button>
  <input id="search" placeholder="ğŸ” æœç´¢ä¹¦å" oninput="loadBooks()">
</div>

<!-- ä¸Šä¼ å›¾ä¹¦è¡¨å• -->
<div id="uploadForm">
  <h3>ğŸ“¥ å¡«å†™å›¾ä¹¦ä¿¡æ¯</h3>
  <input id="title" placeholder="ä¹¦å">
  <input id="author" placeholder="ä½œè€…">
  <input id="isbn" placeholder="ISBN">
  <input id="category" placeholder="åˆ†ç±»">
  <button onclick="uploadBook()">æäº¤ä¸Šä¼ </button>
</div>

<!-- å›¾ä¹¦åˆ—è¡¨è¡¨æ ¼ -->
<table id="bookTable">
  <thead>
    <tr>
      <th>ä¹¦å</th>
      <th>ä½œè€…</th>
      <th>åˆ†ç±»</th>
      <th>ISBN</th>
      <th>æ˜¯å¦å¯å€Ÿ</th>
      <th>å€Ÿå‡ºäººå­¦å·</th>
      <th>å€Ÿå‡ºäººå§“å</th> 
      <th>å€Ÿé˜…æ¬¡æ•°</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>  
  <tbody></tbody>
</table>

<script>
let allBooks = [];

function toggleForm() {
  const form = document.getElementById("uploadForm");
  form.style.display = form.style.display === "none" ? "block" : "none";
}

async function uploadBook() {
  const title = document.getElementById("title").value;
  const author = document.getElementById("author").value;
  const isbn = document.getElementById("isbn").value;
  const category = document.getElementById("category").value;

  const res = await fetch("/api/books", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, author, isbn, category })
  });
  const result = await res.json();
  alert(result.message);
  document.getElementById("uploadForm").style.display = "none";
  loadBooks();
}

async function deleteBook(isbn) {
  if (!confirm("ç¡®å®šåˆ é™¤è¯¥å›¾ä¹¦ï¼Ÿ")) return;
  const res = await fetch("/api/books/" + isbn, { method: "DELETE" });
  const result = await res.json();
  alert(result.message);
  loadBooks();
}

async function updateField(isbn, field, value) {
  await fetch("/api/books/" + isbn, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ field, value })
  });
}

async function loadBooks() {
  const keyword = document.getElementById("search").value.trim();
  const res = await fetch("/api/books");
  allBooks = await res.json();
  const tbody = document.querySelector("#bookTable tbody");
  tbody.innerHTML = "";
  allBooks
    .filter(book => book.title.includes(keyword))
    .forEach(book => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input value="${book.title}" onchange="updateField('${book.isbn}', 'title', this.value)"></td>
        <td><input value="${book.author}" onchange="updateField('${book.isbn}', 'author', this.value)"></td>
        <td><input value="${book.category}" onchange="updateField('${book.isbn}', 'category', this.value)"></td>
        <td>${book.isbn}</td>
        <td>${book.available ? 'âœ…' : 'âŒ'}</td>
        <td>${book.borrowed_by || '-'}</td>
        <td>${book.borrower_name || '-'}</td> <!-- âœ… æ˜¾ç¤ºå§“å -->
        <td>${book.borrow_count || 0}</td>     <!-- âœ… æ˜¾ç¤ºæ¬¡æ•° -->
        <td><button class="action-btn" onclick="deleteBook('${book.isbn}')">åˆ é™¤</button></td>
      `;
      tbody.appendChild(tr);
    });
    
}

loadBooks();
function exportCSV() {
  window.open('/api/export');
}

</script>

</body>
</html>
